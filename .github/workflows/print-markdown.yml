name: Render & Print Markdown (diagnostic)

on:
  workflow_dispatch:
    inputs:
      md_path:
        description: 'Path to markdown file to render (relative to repo root)'
        required: true
        default: 'README.md'
      printer:
        description: 'Optional printer name (overrides default on print server)'
        required: false

jobs:
  render-and-print:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (ci)
        run: |
          npm ci
        working-directory: .
      
      - name: Show environment & node info (debug)
        run: |
          echo "NODE: $(node --version)"
          echo "NPM: $(npm --version)"
          node -e "console.log(JSON.stringify(process.versions,null,2))"
          ls -la
          df -h
        shell: bash

      - name: Run renderer with diagnostics
        env:
          MD_PATH: ${{ github.event.inputs.md_path }}
          PRINT_SERVER_URL: ${{ secrets.PRINT_SERVER_URL }}
          PRINT_SERVER_TOKEN: ${{ secrets.PRINT_SERVER_TOKEN }}
          PRINTER_NAME: ${{ github.event.inputs.printer }}
        run: |
          node ./scripts/render-and-send-diagnostic.js
        working-directory: .
        continue-on-error: true

      - name: Upload debug artifacts (always)
        uses: actions/upload-artifact@v4
        with:
          name: rendered-output
          path: out/
