<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="stylesheet" type="text/css" href="style.css" />
<title>Cygwin Package Server</title>
</head>
<body>

<!--#include virtual="navbar.html" -->
<div id="main">
<!--#include virtual="top.html" -->

<h1>Cygwin Package Server</h1>

<p>
This page documents how to create a directory tree that Cygwin's
setup program understands.
</p>

<p>NOTE: The instructions below may be out of date.  If you can help update this
documentation, please send corrections to the cygwin-apps mailing list.
</p>

<p>
These instructions should be useful for creating a local mirror with or without custom Cygwin
packages. At the present, we recommend using an Apache web server running on a
Linux distribution, but all the required software should work properly on
Cygwin.
</p>

<a id="local-mirror"></a>
<h2 class="cartouche">Creating a local Cygwin mirror with rsync</h2>

<p>
You do not need to know anything about how the directory tree is created if
you just want a copy of an existing directory tree. Simply follow these steps:
</p>

<ol>
<li> The first step in creating a local Cygwin mirror is to pick which
  existing mirror you will download your packages from. A list of
  mirrors can be found <a href="mirrors.html">here</a>.
</li>
<li>
  Download the current Cygwin directory tree.
  If disk space is a problem, you may want to use a
  public mirror and only add your own custom packages as described in the
  next section.  (Substitute your chosen mirror
  for <em>example.com</em> and your DocumentRoot for <em>/var/www/</em>):
  <pre>
    rsync -vaz rsync://<em>example.com/pub/cygwin/ /var/www/</em>cygwin
  </pre>
</li>
<li>
  Test the mirror by pointing a browser at
  <code>http://<em>your-server</em>/cygwin/</code>.
  If your server is configured to show directory indexes, you should see
  the various <i>arch</i> directories, each containing a <code>release</code>
  directory and the compressed <code>setup.ini</code> files.
  Run Cygwin's setup program and type the URL of your server.
</li>
<li>
  Assuming everything works properly, you are almost done. You now have
  a current Cygwin mirror, but you need to keep it updated by running the
  <code>rsync</code> command periodically. The easiest way to do this is by
  putting it in your <code>crontab</code>.
</li>
</ol>

<a id="custom-mirror"></a>
<h2 class="cartouche">Creating a custom Cygwin package server</h2>

<p>
The contents of the directory tree are described to the setup program by a
(compressed) <code>setup.ini</code> file.  This file is generated by the
script <code>mksetupini</code>.
</p>

<p>
  You can obtain the <code>mksetupini</code> script:
</p>
<ul>
  <li>
    on Cygwin, by installing the <code>calm</code> Cygwin package, or
  </li>
  <li>
    directly from  <a href="https://cygwin.com/cgit/cygwin-apps/calm/">Cygwin-apps git</a>.
    <pre>
      pip3 install git+https://cygwin.com/git/cygwin-apps/calm.git
    </pre>
  </li>
</ul>

<p>
If you are planning on creating a custom package
server, we strongly recommend subscribing to the cygwin-apps mailing list
where changes in the <code>setup.ini</code> format and <code>calm</code> are
discussed and announced.
</p>

<ol>
<li>
  Install <code>mksetupini</code>, as described above.
</li>
<li>
  Create a directory to store your files (i.e., the arch/release/ directory
  tree).  I use <code>/var/www/custom-cygwin/</code>.  If you also created a local
  mirror as described above, you can link those files:
  <pre>
    #!/bin/sh
    mkdir custom-cygwin
    cd custom-cygwin
    for ARCH in x86_64 noarch ; do
      mkdir -p ${ARCH}/release
      cd ${ARCH}/release
      ln -s /var/www/cygwin/${ARCH}/release/* .
      cd ../..
    done</pre>
  That way you can use only your custom mirror to get all the packages.  Note
  that whenever a new package is uploaded, you will need to link its directory
  to your custom mirror.
</li>
<li>
  Add your custom package(s) to the directory tree.
</li>
<li> (Optional) Since packages in <code>Base</code> category are always installed,
  you can add an empty package in the <code>Base</code> category that depends on
  several other packages to automatically install them for anyone using your
  custom mirror. For example:
  <pre>
    #!/bin/sh
    mkdir custompackage
    cd custompackage
    tar -Jcf custompackage-0.0.1-1.tar.xz --files-from /dev/null
    tar -Jcf custompackage-0.0.1-1-src.tar.xz --files-from /dev/null
    cat &gt; custompackage-0.0.1-1.hint &lt;&lt; EOF
      sdesc: "My favorite packages"
      ldesc: "My favorite packages"
      category: Base
      requires: bzip2 clear cygwin-doc file less openssh pinfo rxvt wget
    EOF</pre>
</li>
<li>
  Run <code>mksetupini</code> and create compressed <code>setup.ini</code> files for the
  setup program:
  <pre>
    #!/bin/sh
    cd /var/www/custom-cygwin/
    for ARCH in x86_64 ; do
      mksetupini --arch ${ARCH} --inifile=${ARCH}/setup.ini --releasearea=.
      bzip2 &lt;${ARCH}/setup.ini &gt;${ARCH}/setup.bz2
      xz -6e &lt;${ARCH}/setup.ini &gt;${ARCH}/setup.xz
    done</pre>
  You will see error messages from <code>mksetupini</code> about non-existent
  packages if you do not have a full mirror (or if you made an error
  in a <code>.hint</code> file).
</li>
<li>
  Test your mirror with the Cygwin setup program!
</li>
</ol>

<p>
<i>
  TBD: Discuss the need to sign <code>setup.ini</code> files and provide the key
  used with setup's -K option, or use setup's -X option.
</i>
</p>

<p>
<i>
  TBD: The setup-version: line from the mirror should be perpetuated into
  the generated <code>setup.ini</code>.
</i>
</p>

<a id="overlay"></a>
<h2 class="cartouche">Creating an overlay Cygwin package server</h2>

<p>
  Follow the the steps of "<a href="#custom-mirror">Creating a custom Cygwin package
  server</a>" above, with the following modifications.
</p>

<ol>
  <li value="2">
    Instead of copying/linking an existing Cygwin mirror, start with an empty
    directory.
  </li>
  <li value="5">
    <p>
      Add the <code>--disable-check=missing-required-package,missing-depended-package</code>
      option to <code>mksetupini</code> (this turns off checking that all
      dependencies can be found, since presumably some of them will be provided
      by the standard Cygwin package repository).
    </p>
    <p>
      (Additionally, if you are going to overlay an existing package with just
      a <code>test:</code> version in your repository, you will need to use the
      <code>--disable-check=missing-curr</code> option to indicate that it's ok not to have
      a <code>curr:</code> version of a package)
    </p>
  </li>
  <li value="6">
    <p>
      In setup's "Choose A Download Site" page, enter the URL of your repository
      in the "User URL" box, press "Add".  Then ensure <b>both</b> that
      site <b>and</b> a Cygwin mirror site are selected.
    </p>
    <p>
      If using the setup command line, use the <code>--site</code> option once to
      specify a Cygwin mirror, and again to specify your overlay package server.
    </p>
  </li>
</ol>

<p>
<i>
  TBD: Discuss the need to sign <code>setup.ini</code> files and provide the key
  used with setup's -K option, or use setup's -X option.
</i>
</p>

<p>
<i>
  TBD: We are currently lacking a tool to check that cross-repository
  dependencies can be satisfied (i.e. that presumptive packages for these
  dependencies actually exist).  This can be checked by running setup, telling
  it to install <b>everything</b>, and seeing if the "Resolving dependencies"
  page reports any dependencies as not found.
</i>
</p>

<h2 class="cartouche">Historical note on <code>genini</code></h2>

<p>
<code>genini</code> is a script previously used to create <code>setup.ini</code> files.
This can no longer be used as it does not currently support Cygwin packages with
<code>pvr.hint</code> files.
</p>

<p>
You can download <code>genini</code> from the
<a href="https://cygwin.com/cgit/cygwin-apps/genini/">Cygwin-apps git</a>.
</p>

<p>
<code>genini</code> also requires the <code>Archive::Perl</code> module which you can
install via CPAN, or with <code>apt-get install libarchive-tar-perl</code> or
equivalent.
</p>

</div>

</body>
</html>
