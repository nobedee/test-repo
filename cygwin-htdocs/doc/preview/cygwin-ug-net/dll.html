<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Building and Using DLLs</title><link rel="stylesheet" type="text/css" href="docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><link rel="home" href="cygwin-ug-net.html" title="Cygwin User's Guide"><link rel="up" href="programming.html" title="Chapter 4. Programming with Cygwin"><link rel="prev" href="gdb.html" title="Debugging Cygwin Programs"><link rel="next" href="windres.html" title="Defining Windows Resources"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Building and Using DLLs</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="gdb.html">Prev</a> </td><th width="60%" align="center">Chapter 4. Programming with Cygwin</th><td width="20%" align="right"> <a accesskey="n" href="windres.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dll"></a>Building and Using DLLs</h2></div></div></div><p>DLLs are Dynamic Link Libraries, which means that they're linked
into your program at run time instead of build time.  There are three
parts to a DLL:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p> the exports </p></li><li class="listitem"><p> the code and data </p></li><li class="listitem"><p> the import library </p></li></ul></div><p>The code and data are the parts you write - functions,
variables, etc.  All these are merged together, like if you were
building one big object files, and put into the dll.  They are not
put into your .exe at all.</p><p>The exports is a list of functions and variables that the
dll makes available to other programs.  Think of this as the list of
"public" symbols, the rest being hidden.

<a href="#ftn.idp26024685904" class="footnote"><sup class="footnote"><a name="idp26024685904"></a>[1]</sup></a>

This list can be in a module definition (.def) file, which you can write by hand
with a text editor, but it's also possible to have it generated automatically
from the functions and variables in your code, by annotating the declarations
with <code class="code">__attribute__ ((dllexport))</code>.

<a href="#ftn.idp26025460368" class="footnote"><sup class="footnote"><a name="idp26025460368"></a>[2]</sup></a>

</p><p>The import library is a regular UNIX-like <code class="filename">.a</code> library,
but it only contains the tiny bit of information ("a stub") needed to tell the
OS how your program interacts with ("imports") the dll.  This information is
linked into your <code class="filename">.exe</code>.
</p><p>
  Refer to the <a class="ulink" href="https://sourceware.org/binutils/docs/ld/WIN32.html" target="_top">section of the ld
  manual</a> discussing Win32 PE specifics for more details.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="dll-build"></a>Building DLLs</h3></div></div></div><p>This page gives only a few simple examples of gcc's DLL-building
capabilities. To begin an exploration of the many additional options,
see the gcc documentation and website, currently at
<a class="ulink" href="http://gcc.gnu.org/" target="_top">http://gcc.gnu.org/</a>
</p><p>Let's go through a simple example of how to build a dll.
For this example, we'll use a single file
<code class="filename">myprog.c</code> for the program
(<code class="filename">myprog.exe</code>) and a single file
<code class="filename">mydll.c</code> for the contents of the dll
(<code class="filename">mydll.dll</code>).</p><p>Say you want to build this minimal function in
<code class="filename">mydll.c</code>:</p><pre class="screen">
#include &lt;stdio.h&gt;

int
hello()
{
  printf ("Hello World!\n");
}
</pre><p>First compile <code class="filename">mydll.c</code> to the object
<code class="filename">mydll.o</code>:</p><pre class="screen">gcc -c mydll.c</pre><p>Then, tell gcc that it is building a shared library:</p><pre class="screen">gcc -shared -o mydll.dll mydll.o -Wl,--out-implib libmydll.a</pre><p>
  That's it! You now have the dll (<code class="filename">mydll.dll</code>) and the
  import library (<code class="filename">libmydll.a</code>).

<a href="#ftn.idp26023860416" class="footnote"><sup class="footnote"><a name="idp26023860416"></a>[3]</sup></a>

</p><p>
To finish up the example, you can now link to the dll with a simple program,
<code class="filename">myprog.c</code>:
</p><pre class="screen">
int
main ()
{
  hello ();
}
</pre><p>
Then link to your dll with a command like:
</p><pre class="screen">gcc -o myprog myprog.c -L./ -lmydll</pre><p>
  Try it out:
</p><pre class="screen">
$ ./myprog
Hello World!
</pre><p>However, if you are building a dll for installation,
you will probably want to use a more complex syntax:</p><pre class="screen">gcc -shared -o cyg${module}.dll \
    -Wl,--out-implib=lib${module}.dll.a \
    -Wl,--whole-archive ${objs_libs} -Wl,--no-whole-archive \
    ${dependency_libs}</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
The name of your library is <code class="literal">${module}</code>, prefixed with
<code class="literal">cyg</code> for the DLL and <code class="literal">lib</code> for the
import library. Cygwin DLLs use the <code class="literal">cyg</code> prefix to
differentiate them from native-Windows MinGW DLLs.
</li><li class="listitem"><code class="literal">${objs_libs}</code> are all your object files, bundled together in
static libs or single object files
</li><li class="listitem"><code class="literal">${dependency_libs}</code> are static or import libs you need to link
against, e.g <strong class="userinput"><code>'-lpng -lz -L/usr/local/special -lmyspeciallib'
</code></strong>.
</li></ul></div><p>
  When the import library is installed into <code class="filename">/usr/lib</code>, it
  can be linked to with just <code class="code">-l${module}</code>. The dll itself is
  installed into <code class="filename">/usr/bin</code> so it can be found on
  <code class="code">PATH</code> by the loader when a linked .exe is run.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="dll-tool"></a>dlltool</h3></div></div></div><p>
Historically, the process for building a dll with <code class="filename">gcc</code> and
<code class="filename">binutils</code> wasn't so simple, and the
<code class="filename">dlltool</code> tool was used:
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
      To create the exports section of the dll, from the module definition file
      or by scanning object files.
    </p></li><li class="listitem"><p>
      To generate the import library.
    </p></li></ul></div><p>
  (See the <code class="filename">dlltool</code> man page for more details.)
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="dll-link"></a>Linking Against Foreign DLLs</h3></div></div></div><p>If you have an existing DLL already, you need to build a
Cygwin-compatible import library.  If you have the source to compile
the DLL, see <a class="xref" href="dll.html#dll-build" title="Building DLLs">the section called “Building DLLs”</a> for details on having
<code class="filename">gcc</code> build one for you.  If you do not have the
source or a supplied working import library, you can get most of
the way by creating a .def file with these commands (you might need to
do this in <code class="filename">bash</code> for the quoting to work
correctly):</p><pre class="screen">
echo EXPORTS &gt; foo.def
nm foo.dll | grep ' T _' | sed 's/.* T _//' &gt;&gt; foo.def
</pre><p>Note that this will only work if the DLL is not stripped.
Otherwise you will get an error message: "No symbols in
foo.dll".</p><p>Once you have the <code class="filename">.def</code> file, you can create
an import library from it like this:</p><pre class="screen">
dlltool --def foo.def --dllname foo.dll --output-lib foo.a
</pre></div><div class="footnotes"><br><hr style="width:100; align:left;"><div id="ftn.idp26024685904" class="footnote"><p><a href="#idp26024685904" class="para"><sup class="para">[1] </sup></a>
    Note that <code class="filename">ld</code>'s default behaviour is to export all
    global symbols, if there otherwise wouldn't be any exported symbols
    (i.e. because you haven't specified a def file or made any export
    annotations). (See <code class="code">--export-all-symbols</code> in the
    <code class="filename">ld</code> man page for more details.)
  </p></div><div id="ftn.idp26025460368" class="footnote"><p><a href="#idp26025460368" class="para"><sup class="para">[2] </sup></a>
    If you're making these annotations on the declarations in a header which is
    also installed to be included by users of your library, you probably want to
    use macros to do the right thing and increase portability.  See <a class="ulink" href="https://gcc.gnu.org/wiki/Visibility" target="_top">this example</a> for details.
  </p></div><div id="ftn.idp26023860416" class="footnote"><p><a href="#idp26023860416" class="para"><sup class="para">[3] </sup></a>
    In fact, <code class="code">--out-implib</code> is optional in this simple example,
    because <code class="filename">ld</code> can automatically generate import stubs when
    told to link directly to a .dll.  (See <code class="code">--enable-auto-import</code> in
    the <code class="filename">ld</code> man page for more details.)
  </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="gdb.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="programming.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="windres.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Debugging Cygwin Programs </td><td width="20%" align="center"><a accesskey="h" href="cygwin-ug-net.html">Home</a></td><td width="40%" align="right" valign="top"> Defining Windows Resources</td></tr></table></div></body></html>
